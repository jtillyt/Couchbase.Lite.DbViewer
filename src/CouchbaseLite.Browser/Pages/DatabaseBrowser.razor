@page "/"

<PageTitle>Couchbase Lite Browser</PageTitle>

@using CouchbaseLite.Browser.Data
@inject DatabaseService DatabaseService

<EditForm Model="@DbProps" OnValidSubmit="@LoadDatabase">
	<MudPaper class="p-3 p-md-3" style="margin:10px; margin-bottom:30px">

		<MudTextField @bind-Value="DbProps.DatabasePath" HelperText="Database Path" Class="d-flex flex-fill" style="margin-left:10px" />

		<MudExpansionPanel Text="Query">
			<MudTextField T="string" Label="Query" Variant="Variant.Outlined" @bind-Value="DbProps.DatabaseQuery" Class="d-flex flex-fill" Lines="50" />
		</MudExpansionPanel>

		<MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit" style="margin:5px; align-content:end">(Re)Load Database</MudButton>
	</MudPaper>
</EditForm>

<MudPaper style="margin:10px; margin-bottom:30px">
	<MudBlazor.MudList Clickable="true">
		@if (CurrentDb?.DatabaseDocuments != null)
		{
			@foreach (var group in CurrentDb.DatabaseDocumentGroups)
			{
				<MudListItem Text=@(GetGroupLabel(group)) Icon="@Icons.Material.Filled.FormatListBulleted" Style="background: #efefef">
					<NestedList>

						@foreach (var doc in group.Documents)
						{
							<MudBlazor.MudListItem Text=@doc.DisplayName OnClick="@(()=>OnItemClicked(doc))">

							</MudBlazor.MudListItem>
						}
					</NestedList>
				</MudListItem>
			}
		}
		else
		{
			<MudText style="margin-left:10px">No documents found</MudText>
		}
	</MudBlazor.MudList>
</MudPaper>

<MudPaper style="margin:10px; margin-bottom:30px">
	<MudText Style="margin-left:10px">Results: @(CurrentDb?.ResultCount??0)</MudText>
</MudPaper>

	@code {


	public DatabaseViewerProperties? DbProps { get; set; }
	public LoadedDatabase? CurrentDb { get; set; }
	protected override async Task OnInitializedAsync()
	{
		DbProps = new DatabaseViewerProperties()
			{
				ViewerId = Guid.NewGuid()
			};
	}

	private void LoadDatabase()
	{
		CurrentDb = DatabaseService.LoadDb(DbProps);

		StateHasChanged();
	}

	private string GetGroupLabel(DatabaseDocumentGroup group)
	{
		return group.GroupName + " (" + group.Documents.Count + ")";
	}

	private void OnItemClicked(DatabaseDocument databaseDocument)
	{

	}
}
